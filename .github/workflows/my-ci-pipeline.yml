name: Continuous Integration
on:
  push:
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'
jobs:
  to-do-app-tests:
    name: run pytests
    runs-on: ubuntu-latest
    steps:
    -  uses: actions/checkout@v2
    -  run: docker build --target test --tag my-test-image .
    -  run: docker run my-test-image

  to-do-app-production:
    name: Build and Deploy to Azure
    runs-on: ubuntu-latest
    needs: to-do-app-tests
    steps:
    -  uses: actions/checkout@v2
    -  run: docker build --target production --tag ${{ secrets.DOCKERHUB_USERNAME }}/todoapp .
    -  run: echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
    -  run: docker push docker.io/${{ secrets.DOCKERHUB_USERNAME }}/todoapp
    -  run: curl -dH -X POST "${{ secrets.JP_AZURE_WEBHOOK}}"